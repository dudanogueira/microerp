{% extends "frontend/frontend-base.html" %}
{% load sekizai_tags %}
{% load thumbnail %}

<title>{%block title %}{{block.super}} - Produção - Ordem de Compra{% endblock %}</title>

{% block content %}
<h1><i class="icon-th"></i> <i class="icon-briefcase"></i>  Ordem de Compra</h1>

<p class="btn-group">
	
	<!-- Button to trigger FILTRO modal -->
	<a href="#FiltroModal" role="button" class="btn btn-primary" data-toggle="modal"><i class="icon-filter"></i> Filtrar</a>
 
	<!-- Button to trigger ADD ORDEM -->
	<a href="#AddOrdemModal" role="button" class="btn btn-success" data-toggle="modal"><i class="icon-plus"></i> Adicionar Ordem de Compra</a>
	{% if filtro %}
	<a class="btn" href="{% url "producao:ordem_de_compra" %}">Limpar Filtro</a> 
	{% endif %}
	
</p>

<div id="lista-ordens">
	
	<div class="accordion" id="accordion-ordens-compra">
		
		{% for ordem in ordens %}
		<div class="accordion-group">
			<div class="accordion-heading">
				<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-ordens-compra"  href="#collapse-ordem-{{ordem.id}}">
					<table class="table table-condensed table-striped table-rounded nomargin">
						<thead>
							<tr>
								<th>Status</th>
								<th>ID</th>
								<th>Valor</th>
								<th>Descrição</th>
								<th>Fornecedor</th>
								<th>Nota Fiscal</th>
								<th>Criticidade</th>
								<th>Data de Abertura</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>{% if ordem.data_fechado %}
									<span class="badge badge-success">FECHADO</span>
									{% else %}
									<span class="badge badge-important">ABERTO</span>
									{% if ordem.atrasada %}
										<span class="badge badge-important">Atrasada</span>
									{% else %}
										<span class="badge badge-success">Em dia</span>
									{% endif %}
									
									{% endif %}
								</td>
							
								<td>{{ordem.id}}</td>
								<td>R${{ordem.valor|floatformat:2}}</td>
								<td>{{ordem.descricao}}</td>
								<td>{{ordem.fornecedor}}</td>
								<td>{{ordem.notafiscal}}</td>
								<td>
										
										{% ifequal ordem.criticidade 0 %}
										<span class="badge badge-success">
											{% endifequal %}
											{% ifequal ordem.criticidade 1 %}
											<span class="badge badge-warning">
												{% endifequal %}
												{% ifequal ordem.criticidade 2 %}
												<span class="badge badge-important">
													{% endifequal %}
													{{ordem.get_criticidade_display}}
												</span>
										
										
								</td>
								<td>{{ordem.data_aberto|date:"SHORT_DATE_FORMAT"}}</td>
							</tr>
						</tbody>
					</table>					
					
				</a>
			</div>
			<div id="collapse-ordem-{{ordem.id}}" class="accordion-body collapse">
				<div class="accordion-inner">
								{# Informacoes da Ordem #}
					
					
					

								{% if not ordem.data_fechado %}
								{# BOTOES PARA EDITAR, SE ABERTO #}
								{% if request.user.perfilacessoproducao.gerente %}
								<div class="botoes-editar-fechar">
									<p class="btn-group">
										<a href="		{% url "producao:ordem_de_compra_editar" ordem.id %}" class="btn btn-primary"><i class="icon-pencil"></i> Editar</a>
										<a href="		{% url "producao:ordem_de_compra_fechar" ordem.id %}" class="btn btn-success"><i class="icon-check"></i> Fechar Ordem</a>	
									</p>
								</div>
								{% endif %}
					
								{% else %}
								<strong>Tempo que ficou aberto</strong>: {{ordem.data_aberto|timesince}}<br />
								<strong>Data de Fechamento</strong>: {{ordem.data_fechado|date:"SHORT_DATE_FORMAT"}}
								{% endif %}
					
								<h3>Atividades</h3>
								<div class="atividades-{{ordem.id}}">
									<ul>
										{% for atividade in ordem.atividadedeordemdecompra_set.all %}
										{% if atividade.data_fechado %}
										<li><span class="badge badge-success">{{atividade.data|date:"SHORT_DATE_FORMAT"}}</span> - {{atividade.descricao}}, <small>fechado em {{atividade.data_fechado|date:"SHORT_DATETIME_FORMAT"}} por {{atividade.fechado_por.funcionario}}</small>
										</li>
										{% else %}
										<li><span class="badge badge-important">{{atividade.data|date:"SHORT_DATE_FORMAT"}}</span>
											{% if atividade.atrasada %}
												<span class="badge badge-important">Atrasada</span>
											{% else %}
												<span class="badge badge-success">Em dia</span>
											{% endif %} - <strong>{{atividade.descricao}}</strong>, <small>aberto há {{atividade.data|timesince}}</small>
											{% if request.user.perfilacessoproducao.gerente %}
							
											<a href="{% url "producao:ordem_de_compra_atividade_fechar" atividade.ordem_de_compra.id atividade.id %}" class="btn btn-success"><i class="icon-check"></i></a> <a href="{% url "producao:ordem_de_compra_atividade_remover" atividade.ordem_de_compra.id atividade.id %}" class="btn btn-danger"><i class="icon-trash"></i></a>
							
											{% endif %}
										</li>
										{% endif %}
										{% empty %}
										<small>Nenhuma Atividade. Edite a Ordem de Compra e Adicione uma nova atividade.</small>
										{% endfor %}
									</ul>
								</div>
					
								<h3>Componentes Vinculados</h3>
								<table class="table table-condensed table-striped table-hover table-rounded nomargin table-bordered">
									<thead>
										<tr>
											<th>Componente</th>
											<th>Descrição</th>
											<th>Quantidade</th>
											<th>Valor</th>
										</tr>
									</thead>
									<tbody>
										{% for vinculado in ordem.componentesdaordemdecompra_set.all %}
										<tr>
											<td>{{vinculado.componente_comprado.part_number}}</td>
											<td>{{vinculado.componente_comprado.descricao}}</td>
											<td>{{vinculado.quantidade_comprada}} {{vinculado.componente_comprado.medida}}</td>
											<td>R$ {{vinculado.valor|floatformat:2}}</td>
										</tr>
										{% endfor %}
									</tbody>
								</table>
					
				</div>
			</div>
		</div>
		{% endfor %}
		
	</div>
	
	
				<!-- Modal FILTRO -->
				<div id="FiltroModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						<h3 id="myModalLabel"><i class="icon-filter"></i> Filtrar</h3>
					</div>
					<div class="modal-body">
	    
						<form class="form-horizontal" method="POST" id="filtro-ordem-compra">
							{% csrf_token %}
							{{form_filtro.as_p}}
						</form>
			
			
					</div>
					<div class="modal-footer">
						<button class="btn" data-dismiss="modal" aria-hidden="true">Fechar</button>
						<button form="filtro-ordem-compra" type="submit" class="btn btn-primary" name="form-filtrar-ordem-de-compra" value="filtrar"><i class="icon-filter"></i> Filtrar</button>
			

					</div>
				</div>
 
 
				<!-- Modal ADD ORDEM -->
				<div id="AddOrdemModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
						<h3 id="myModalLabel"><i class="icon-plus"></i> Adicionar Ordem de Compra</h3>
					</div>
					<div class="modal-body">
	    
						<form method="POST" id="form-add-ordem">
							{% csrf_token %}
							{{form_adicionar_ordem_de_compra.as_p}}
						</form>
			
			
					</div>
					<div class="modal-footer">
						<button class="btn" data-dismiss="modal" aria-hidden="true">Fechar</button>
						<button type="submit" class="btn btn-success" name="form-adicionar-ordem-de-compra" form="form-add-ordem" value="adicionar"><i class="icon-plus"></i> Adicionar</button>
						
			

					</div>
				</div>
	
	

				{% endblock %}

				{% block auxiliar-menu %}

				{% addtoblock "js" %}
				<script type="text/javascript" src="{{STATIC_URL}}js/select2.js"></script>
				<link href="{{STATIC_URL}}css/select2.css" type="text/css" media="screen" rel="stylesheet" />
				<link href="{{ STATIC_URL }}frontend/css/ui-lightness/jquery-ui-date-picker.min.css" rel="stylesheet">
				<script src="{{ STATIC_URL }}frontend/js/jquery-ui-datepicker.js"></script>

				<script>
				$(document).ready(function() {
					$("#menu-producao-ordem-de-compra, #top-menu-producao").addClass("active");
	
					$( ".datepicker" ).datepicker({
						inline: true,
						dateFormat: "dd/mm/yy"
        
					});
					$(".nopoint").keyup(function() {
						$(this).val($(this).val().replace(/[.]/g, ""));
					});
	
				  {% if form_adicionar_ordem_de_compra.errors %}
				  $('#AddOrdemModal').modal('show');
				  {% endif %}
					
	
					
	
				});

				</script>
				{% endaddtoblock %}
				{% include "frontend/producao/producao-menu.html" %}
				{% endblock%}